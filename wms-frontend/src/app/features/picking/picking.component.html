<div class="picking-container">
  <mat-card class="create-order-card">
    <mat-card-header
      (click)="isFormCollapsed.set(!isFormCollapsed())"
      class="collapsible-header"
    >
      <mat-card-title>Create a New Pick List</mat-card-title>
      <button
        mat-icon-button
        class="collapse-toggle-button"
        matTooltip="Toggle Form"
        aria-label="Toggle form visibility"
      >
        <mat-icon>
          {{ isFormCollapsed() ? 'keyboard_arrow_down' : 'keyboard_arrow_up' }}
        </mat-icon>
      </button>
    </mat-card-header>

    @if (!isFormCollapsed()) {
      <mat-card-content [formGroup]="orderForm">
        <div class="compact-form-layout">
          <mat-form-field appearance="outline" class="account-selector">
            <mat-label>Customer Account</mat-label>
            <input
              type="text"
              placeholder="Start typing to search..."
              matInput
              formControlName="accountSearch"
              [matAutocomplete]="autoAccount"
              aria-describedby="account-hint"
            >
            <mat-autocomplete
              #autoAccount="matAutocomplete"
              [displayWith]="displayAccountName.bind(this)"
              (optionSelected)="onAccountChange($event.option.value)"
            >
              <cdk-virtual-scroll-viewport itemSize="48" minBufferPx="200" maxBufferPx="400" class="autocomplete-viewport">
                @for(acc of filteredAccounts(); track acc.id) {
                  <mat-option [value]="acc">
                    {{ acc.name }}
                  </mat-option>
                }
              </cdk-virtual-scroll-viewport>
            </mat-autocomplete>
            <mat-hint id="account-hint">Select the customer account for this pick list</mat-hint>
          </mat-form-field>

          <div class="form-options"> <mat-checkbox formControlName="isExpedited" color="warn" class="expedited-checkbox">
              Expedited Order (Rush)
            </mat-checkbox>
            <div class="form-actions">
              <button
                mat-stroked-button
                (click)="addOrderItem()"
                [disabled]="orderItems.disabled"
                aria-label="Add new order item"
              >
                <mat-icon>add</mat-icon>
                <span>Add Line</span>
              </button>
              <button
                mat-stroked-button
                color="primary"
                (click)="createPickList()"
                [disabled]="orderForm.invalid || isCreating()"
                aria-label="Create pick list"
              >
                @if(isCreating()) {
                  <mat-spinner diameter="20" style="margin-right: 8px;"></mat-spinner>
                }
                <span>Create Pick List</span>
              </button>
            </div>
          </div>
        </div>

        @if (orderForm.get('accountId')?.value) {
          <div formArrayName="orderItems" class="order-items-container">
            @for(item of orderItems.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="order-item-row">
                <mat-form-field appearance="outline" class="material-select">
                  <mat-label>Material</mat-label>
                  <input
                    type="text"
                    placeholder="Search for material or SKU..."
                    matInput
                    formControlName="materialSearch"
                    [matAutocomplete]="autoMaterial"
                    [attr.aria-label]="'Material search for item ' + (i + 1)"
                  >
                  <mat-autocomplete
                    #autoMaterial="matAutocomplete"
                    [displayWith]="displayMaterialName"
                    (optionSelected)="onMaterialSelected($event.option.value, i)"
                  >
                    <cdk-virtual-scroll-viewport itemSize="48" minBufferPx="200" maxBufferPx="400" class="autocomplete-viewport">
                      @for(mat of item.get('filteredMaterials')?.value; track mat.id) {
                        <mat-option [value]="mat">
                          {{ mat.name }} ({{ mat.sku }})
                        </mat-option>
                      }
                    </cdk-virtual-scroll-viewport>
                  </mat-autocomplete>
                  @if(materials().length === 0) {
                    <mat-hint>No pickable inventory for this account.</mat-hint>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="quantity-input">
                  <mat-label>Quantity</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="quantity"
                    min="1"
                    [attr.aria-label]="'Quantity for item ' + (i + 1)"
                  >
                </mat-form-field>

                <button
                  mat-icon-button
                  color="warn"
                  (click)="removeOrderItem(i)"
                  [disabled]="orderItems.controls.length <= 1"
                  matTooltip="Remove Line"
                  aria-label="Remove this order item"
                >
                  <mat-icon>remove_circle_outline</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </mat-card-content>
    }
  </mat-card>

  <section class="active-list-section" aria-labelledby="active-picks-heading">
    @if (isLoading()) {
      <div class="spinner-container" aria-label="Loading pick lists">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      </div>
    } @else {
      <div class="pick-groups-grid">
        @for (group of pickListGroups(); track group.accountId) {
          <mat-card class="pick-group-card">
            <mat-card-header>
              <div mat-card-avatar class="account-avatar" aria-hidden="true">
                <mat-icon>account_circle</mat-icon>
              </div>
              <mat-card-title>{{ group.accountName }}</mat-card-title>
              <mat-card-subtitle>
                {{ group.items.length }} item(s) to pick
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <mat-list aria-label="Pick items for {{ group.accountName }}">
                @for(item of group.items; track item.pickId) {
                  <mat-list-item class="pick-item">
                    <div class="pick-item-content">
                       <div class="item-status-indicator" aria-hidden="true">
                          <mat-icon [ngClass]="item.status.toLowerCase()">
                            {{ item.status === 'Confirmed' ? 'check_circle' :
                               (item.status === 'Short' ? 'warning' : 'pending') }}
                          </mat-icon>
                        </div>
                        <div class="item-details-main">
                          <div class="item-title">
                            {{ item.material }}
                            <span class="item-sku">({{ item.sku }})</span>
                          </div>
                          <div class="item-meta">
                            <span>Location: <strong class="item-location">{{ item.location }}</strong></span>
                            <span>Quantity: <strong class="item-quantity">{{ item.quantity }}</strong></span>
                          </div>
                        </div>
                        <div class="item-actions">
                          @if (item.status === 'Planned') {
                            <button mat-icon-button color="warn" (click)="markAsShort(item)" matTooltip="Mark as Short" [attr.aria-label]="'Mark ' + item.material + ' as short'" class="action-button">
                              <mat-icon>warning</mat-icon>
                            </button>
                            <button mat-icon-button color="primary" (click)="openScanDialog(item)" matTooltip="Scan to Confirm" [attr.aria-label]="'Scan to confirm ' + item.material" class="action-button">
                              <mat-icon>qr_code_scanner</mat-icon>
                            </button>
                          } @else {
                            <span class="status-badge" [ngClass]="'status-badge-' + item.status.toLowerCase()" [attr.aria-label]="'Status: ' + item.status">{{ item.status }}</span>
                          }
                        </div>
                    </div>
                  </mat-list-item>
                }
              </mat-list>
            </mat-card-content>
          </mat-card>
        } @empty {
          <mat-card>
            <mat-card-content>
              <div class="empty-list-message" aria-label="No pending picks">
                <mat-icon>checklist</mat-icon>
                <h3>No pending picks assigned.</h3>
                <p>Create a new pick list to get started.</p>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    }
  </section>
</div>
