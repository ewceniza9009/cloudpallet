<div class="report-container">
  <div class="header-section">
    <div>
      <h1 class="mat-headline-6">Order Picking</h1>
      <p class="mat-body-1">Manage outbound orders and generate pick lists.</p>
    </div>
  </div>

  <mat-card class="create-order-card">
    <mat-card-header (click)="isFormCollapsed.set(!isFormCollapsed())" class="collapsible-header">
      <mat-card-title>Create New Pick List</mat-card-title>
      <button mat-icon-button class="collapse-toggle-button" matTooltip="Toggle Form">
        <mat-icon>{{ isFormCollapsed() ? 'keyboard_arrow_down' : 'keyboard_arrow_up' }}</mat-icon>
      </button>
    </mat-card-header>

    @if (!isFormCollapsed()) {
      <mat-card-content [formGroup]="orderForm">
        <div class="filter-grid">
          <!-- Account Selector -->
          <mat-form-field appearance="outline" class="custom-field">
            <mat-label>Customer Account</mat-label>
            <input matInput formControlName="accountSearch" [matAutocomplete]="autoAccount" placeholder="Select Account" (click)="accountAutoTrigger.openPanel()" (focus)="accountAutoTrigger.openPanel()" #accountAutoTrigger="matAutocompleteTrigger">
            <mat-autocomplete #autoAccount="matAutocomplete" [displayWith]="displayAccountName.bind(this)" (optionSelected)="onAccountChange($event.option.value)">
              @for(acc of filteredAccounts(); track acc.id) {
                <mat-option [value]="acc">{{ acc.name }}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>

          <!-- Expedited Checkbox -->
           <div class="checkbox-wrapper">
            <mat-checkbox formControlName="isExpedited" color="warn">Expedited (Rush)</mat-checkbox>
           </div>

          <!-- Action Buttons -->
          <div class="filter-actions">
            <button mat-stroked-button (click)="addOrderItem()" [disabled]="orderItems.disabled">
              <mat-icon>add</mat-icon> Add Line
            </button>
            <button mat-flat-button color="primary" (click)="createPickList()" [disabled]="orderForm.invalid || isCreating()">
              @if(isCreating()) { <mat-spinner diameter="20"></mat-spinner> }
              <span>Create Pick List</span>
            </button>
          </div>
        </div>

        <!-- Order Items List -->
        @if (orderForm.get('accountId')?.value) {
          <div formArrayName="orderItems" class="order-items-container">
            @for(item of orderItems.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="order-item-row">
                <mat-form-field appearance="outline" class="custom-field material-select">
                  <mat-label>Material</mat-label>
                  <input matInput formControlName="materialSearch" [matAutocomplete]="autoMaterial" placeholder="Select Material" (click)="materialAutoTrigger.openPanel()" (focus)="materialAutoTrigger.openPanel()" #materialAutoTrigger="matAutocompleteTrigger">
                  <mat-autocomplete #autoMaterial="matAutocomplete" [displayWith]="displayMaterialName" (optionSelected)="onMaterialSelected($event.option.value, i)">
                    @for(mat of item.get('filteredMaterials')?.value; track mat.id) {
                      <mat-option [value]="mat">{{ mat.name }} ({{ mat.sku }})</mat-option>
                    }
                  </mat-autocomplete>
                </mat-form-field>

                <mat-form-field appearance="outline" class="custom-field quantity-input">
                  <mat-label>Qty</mat-label>
                  <input matInput type="number" formControlName="quantity" min="1">
                </mat-form-field>

                <button mat-icon-button color="warn" (click)="removeOrderItem(i)" [disabled]="orderItems.controls.length <= 1" matTooltip="Remove Line">
                  <mat-icon>remove_circle_outline</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </mat-card-content>
    }
  </mat-card>

  <section class="active-list-section" aria-labelledby="active-picks-heading">
    @if (isLoading()) {
      <div class="spinner-container">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      </div>
    } @else {
      <div class="pick-groups-grid">
        @for (group of pickListGroups(); track group.accountId) {
          <mat-card class="pick-group-card">
            <mat-card-header>
              <div mat-card-avatar class="account-avatar">
                <mat-icon>business</mat-icon>
              </div>
              <mat-card-title>{{ group.accountName }}</mat-card-title>
              <mat-card-subtitle>
                {{ group.items.length }} item(s) to pick
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <mat-list>
                @for(item of group.items; track item.pickId) {
                  <mat-list-item class="pick-item">
                    <div class="pick-item-content">
                        <div class="item-status-indicator">
                          <mat-icon [ngClass]="item.status.toLowerCase()">
                            {{ item.status === 'Confirmed' ? 'check_circle' :
                               (item.status === 'Short' ? 'warning' : 'pending') }}
                          </mat-icon>
                        </div>
                        
                        <div class="item-details-main">
                          <div class="item-title">
                            {{ item.material }}
                            <span class="item-sku">({{ item.sku }})</span>
                          </div>
                          <div class="item-meta">
                            <span>Loc: <strong>{{ item.location }}</strong></span>
                            <span>Qty: <strong>{{ item.quantity }}</strong></span>
                          </div>
                        </div>

                        <div class="item-actions">
                          @if (item.status === 'Planned') {
                            <button mat-icon-button color="warn" (click)="deleteItem(item)" matTooltip="Delete" class="action-button">
                              <mat-icon>delete</mat-icon>
                            </button>
                            <button mat-icon-button color="warn" (click)="markAsShort(item)" matTooltip="Mark Short" class="action-button">
                              <mat-icon>warning</mat-icon>
                            </button>                           
                            <button mat-icon-button color="primary" (click)="openScanDialog(item)" matTooltip="Scan" class="action-button">
                              <mat-icon>qr_code_scanner</mat-icon>
                            </button>
                          } @else {
                            <span class="status-badge" [ngClass]="'status-badge-' + item.status.toLowerCase()">{{ item.status }}</span>
                          }
                        </div>
                    </div>
                  </mat-list-item>
                }
              </mat-list>
            </mat-card-content>
          </mat-card>
        } @empty {
          <mat-card class="empty-card">
            <mat-card-content>
              <div class="empty-list-message">
                <mat-icon>checklist</mat-icon>
                <h3>No pending picks.</h3>
                <p>Create a new pick list to get started.</p>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    }
  </section>
</div>