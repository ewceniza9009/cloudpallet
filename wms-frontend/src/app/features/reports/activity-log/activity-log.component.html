<div class="report-container">
  <div class="header-section">
    <div>
      <h1 class="mat-headline-6">Activity Log</h1>
      <p class="mat-body-1">Search and review a detailed, chronological history of all user and system transactions.</p>
    </div>
  </div>

  <div class="filters-section">
    <div [formGroup]="filterForm" class="filter-grid">
      <mat-form-field appearance="outline" class="custom-field" subscriptSizing="dynamic">
        <mat-label>Date Range</mat-label>
        <mat-date-range-input [formGroup]="filterForm">
          <input matStartDate formControlName="startDate" placeholder="Start date">
          <input matEndDate formControlName="endDate" placeholder="End date">
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="custom-field" subscriptSizing="dynamic">
        <mat-label>Customer Account</mat-label>
        <input matInput [formControl]="accountControl" [matAutocomplete]="accountAuto" placeholder="Select Account" #triggerAccount="matAutocompleteTrigger" (click)="triggerAccount.openPanel()">
        <mat-autocomplete #accountAuto="matAutocomplete" [displayWith]="getDisplayName">
          @for(item of filteredAccounts$ | async; track item.id) {
          <mat-option [value]="item">{{item.name}}</mat-option>
          }
        </mat-autocomplete>
        <mat-icon matSuffix>business</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="custom-field" subscriptSizing="dynamic">
        <mat-label>User</mat-label>
        <input matInput [formControl]="userControl" [matAutocomplete]="userAuto" placeholder="Select User" #triggerUser="matAutocompleteTrigger" (click)="triggerUser.openPanel()">
        <mat-autocomplete #userAuto="matAutocomplete" [displayWith]="getDisplayName">
          @for(item of filteredUsers$ | async; track item.id) {
          <mat-option [value]="item">{{item.name}}</mat-option>
          }
        </mat-autocomplete>
        <mat-icon matSuffix>person</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="custom-field" subscriptSizing="dynamic">
        <mat-label>Truck</mat-label>
        <input matInput [formControl]="truckControl" [matAutocomplete]="truckAuto" placeholder="Select Truck" #triggerTruck="matAutocompleteTrigger" (click)="triggerTruck.openPanel()">
        <mat-autocomplete #truckAuto="matAutocomplete" [displayWith]="getDisplayName">
          @for(item of filteredTrucks$ | async; track item.id) {
          <mat-option [value]="item">{{item.name}}</mat-option>
          }
        </mat-autocomplete>
        <mat-icon matSuffix>local_shipping</mat-icon>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-stroked-button (click)="resetFilters()">Clear</button>
        <button mat-flat-button color="primary" (click)="applyFilters()">
          <mat-icon>filter_list</mat-icon>
          <span>Apply</span>
        </button>
      </div>
    </div>
  </div>

    <div class="content-wrapper">
    @if (isLoading()) {
    <div class="spinner-container-page">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>Loading Activity...</p>
    </div>
    } @else {
    @if (data().length === 0) {
    <div class="empty-list-message">
      <mat-icon>search_off</mat-icon>
      <h2>No Activity Found</h2>
      <p>No transactions match the current filter criteria.</p>
    </div>
    } @else {
    <div class="timeline-container">
      @for(item of data(); track $index) {
      <div class="timeline-item">
        <div class="timeline-marker">
          <div class="timeline-icon">
            <mat-icon>{{ getIconForAction(item.action) }}</mat-icon>
          </div>
          <div class="timeline-line" *ngIf="!$last"></div>
        </div>
        
        <div class="timeline-content">
          <mat-card class="timeline-card">
            <div class="card-content-wrapper">
              <div class="event-header">
                <div class="user-info">
                  <span class="user-name">{{ item.user }}</span>
                  <span class="action-text">performed</span>
                  <span class="action-badge">{{ item.action }}</span>
                </div>
                <span class="event-timestamp">{{ item.timestamp | date:'MMM d, y, h:mm a' }}</span>
              </div>
              <div class="event-details">
                <div class="detail-row">
                  <mat-icon class="detail-icon">notes</mat-icon>
                  <span class="detail-text">{{ item.description }} for account: <strong>{{ item.account }}</strong></span>
                </div>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
      }
    </div>
    }
    }
    <mat-paginator [length]="resultsLength()" [pageSizeOptions]="[25, 50, 100]" showFirstLastButtons class="custom-paginator"></mat-paginator>
  </div>
</div>
