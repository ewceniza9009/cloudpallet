<div class="management-container">
  <div class="header-section">
    <h1 class="mat-headline-6">Dock Scheduler</h1>
    <p class="mat-body-1">Schedule and view all dock appointments.</p>
  </div>

  <div class="scheduler-grid">
    <div class="main-content-col">
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-card-title>View Schedule</mat-card-title>
        </mat-card-header>
        <mat-card-content [formGroup]="selectionForm" class="selection-controls">
          <mat-form-field appearance="outline" class="custom-field">
            <mat-label>Select Dock</mat-label>
            <mat-select formControlName="dockId">
              @for (dock of docks(); track dock.id) {
              <mat-option [value]="dock.id">
                <span class="dock-option">
                  <span class="status-dot" [class.available]="dock.isAvailable"></span>
                  {{ dock.name }}
                </span>
              </mat-option>
              }
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="custom-field">
            <mat-label>Appointment Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="selectedDate" />
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <mat-card class="list-card">
        <mat-card-header>
          @if (searchControl.value) {
          <mat-card-title>Search Results for "{{ searchControl.value }}"</mat-card-title>
          } @else {
          <mat-card-title
            >Appointments for
            {{ selectionForm.controls.selectedDate.value | date : 'longDate' }}</mat-card-title
          >
          }
        </mat-card-header>

        <div class="list-search-bar">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="custom-field">
            <mat-label>Search by License Plate</mat-label>
            <input matInput [formControl]="searchControl" placeholder="e.g., TRUCK-01" />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <mat-card-content>
          @if (isLoading()) {
          <div class="spinner-container">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          </div>
          } @else if (error(); as errorMessage) {
          <p class="error-message">{{ errorMessage }}</p>
          } @else { @if (appointments().length > 0) {
          <mat-list role="list">
            @for (apt of appointments(); track apt.id) {
            <mat-list-item role="listitem">
              <mat-icon matListItemIcon>local_shipping</mat-icon>
              <div matListItemTitle class="appointment-title">{{ apt.licensePlate }}</div>
              <div matListItemLine class="appointment-details">
                <span
                  >Scheduled:
                  <strong
                    >{{ apt.startDateTime | date : 'shortTime' }} -
                    {{ apt.endDateTime | date : 'shortTime' }}</strong
                  ></span
                >
                <span class="detail-separator">|</span>
                <span
                  >Dock: <strong>{{ apt.dockName }}</strong></span
                >
                @if(apt.yardSpotNumber) {
                <span class="detail-separator">|</span>
                <span
                  >Yard: <strong>{{ apt.yardSpotNumber }}</strong></span
                >
                }
                <span class="status-chip">{{ apt.status }}</span>
              </div>
            </mat-list-item>
            }
          </mat-list>
          } @else {
          <div class="empty-list-message">
            <mat-icon>event_busy</mat-icon>
            <p>No appointments found for the selected criteria.</p>
          </div>
          } }
        </mat-card-content>
      </mat-card>
    </div>

    <div class="sidebar-col">
      <mat-card class="detail-card sticky-sidebar">
        <mat-card-header>
          <mat-card-title>Schedule New Appointment</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
            <mat-radio-group formControlName="type" class="appointment-type-selector">
              <mat-radio-button value="Receiving">Inbound (Receiving)</mat-radio-button>
              <mat-radio-button value="Shipping">Outbound (Shipping)</mat-radio-button>
            </mat-radio-group>

            <mat-form-field appearance="outline">
              <mat-label>Truck License Plate</mat-label>
              <input
                matInput
                [formControl]="truckControl"
                [matAutocomplete]="truckAuto"
                placeholder="Search or type license plate"
              />
              <mat-autocomplete
                #truckAuto="matAutocomplete"
                [displayWith]="truckDisplayFn"
                (optionSelected)="onTruckSelected($event)"
              >
                @for(t of filteredTrucks(); track t.id) {
                <mat-option [value]="t">{{ t.licensePlate }}</mat-option>
                }              
              </mat-autocomplete>
              <input type="hidden" formControlName="licensePlate" />
              <mat-autocomplete
                #truckAuto="matAutocomplete"
                [displayWith]="getDisplayName"
                (optionSelected)="onTruckSelected($event)"
              >
                @for(t of filteredTrucks(); track t.id) {
                <mat-option [value]="t">{{ t.licensePlate }}</mat-option>
                }
              </mat-autocomplete>
              <input type="hidden" formControlName="licensePlate" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Supplier</mat-label>
              <input
                matInput
                [formControl]="supplierControl"
                [matAutocomplete]="supplierAuto"
                placeholder="Search supplier"
              />
              <mat-autocomplete
                #supplierAuto="matAutocomplete"
                [displayWith]="getDisplayName"
                (optionSelected)="onSupplierSelected($event)"
              >
                @for(s of filteredSuppliers(); track s.id) {
                <mat-option [value]="s">{{ s.name }}</mat-option>
                }
              </mat-autocomplete>
              <input type="hidden" formControlName="supplierId" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Customer Account</mat-label>
              <input
                matInput
                [formControl]="accountControl"
                [matAutocomplete]="accountAuto"
                placeholder="Search customer account"
              />
              <mat-autocomplete
                #accountAuto="matAutocomplete"
                [displayWith]="getDisplayName"
                (optionSelected)="onAccountSelected($event)"
              >
                @for(a of filteredAccounts(); track a.id) {
                <mat-option [value]="a">{{ a.name }}</mat-option>
                }
              </mat-autocomplete>
              <input type="hidden" formControlName="accountId" />
            </mat-form-field>

            <div class="time-fields">
              <mat-form-field appearance="outline">
                <mat-label>Start Time</mat-label>
                <input matInput type="time" formControlName="startTime" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>End Time</mat-label>
                <input matInput type="time" formControlName="endTime" />
              </mat-form-field>
            </div>

            <button
              mat-stroked-button
              color="primary"
              type="submit"
              [disabled]="appointmentForm.invalid || !selectionForm.valid || isSubmitting()"
            >
              @if (isSubmitting()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Scheduling...</span>
              } @else {
              <ng-container>
                <mat-icon>add_circle</mat-icon>
                <span>Schedule Appointment</span>
              </ng-container>
              }
            </button>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
