@if(isLoading()) {
<div class="spinner-container">
  <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  <span>Loading carrier...</span>
</div>
} @else {
<div class="detail-container">
  <div class="detail-header">
    <div class="header-main">
      <a mat-icon-button (click)="back()" matTooltip="Back to List">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <div class="title-group">
        <h2>
          {{ carrierId() ? carrierForm.get("name")?.value : "New Carrier" }}
        </h2>
        <p class="subtitle">
          {{
            carrierId()
              ? "Edit details for this carrier."
              : "Create a new carrier."
          }}
        </p>
      </div>
    </div>
    <div class="header-actions">
      @if(carrierId()) { @if(isEditMode()) {
      <button mat-stroked-button (click)="toggleEditMode(false)">
        <mat-icon>cancel</mat-icon>
        <span>Cancel</span>
      </button>
      <button
        mat-flat-button
        color="primary"
        (click)="save()"
        [disabled]="isSaving()"
      >
        @if(isSaving()) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
        <span>Saving...</span>
        } @else {
        <ng-container>
          <mat-icon>save</mat-icon>
          <span>Save Changes</span>
        </ng-container>
        }
      </button>
      } @else {
      <button
        mat-stroked-button
        color="warn"
        (click)="delete()"
        [disabled]="isDeleting()"
      >
        @if(isDeleting()) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
        <span>Deleting...</span>
        } @else {
        <ng-container>
          <mat-icon>delete</mat-icon>
          <span>Delete</span>
        </ng-container>
        }
      </button>
      <button mat-stroked-button color="primary" (click)="toggleEditMode(true)">
        <mat-icon>edit</mat-icon>
        <span>Edit</span>
      </button>
      } } @else {
      <button
        mat-flat-button
        color="primary"
        (click)="save()"
        [disabled]="isSaving()"
      >
        @if(isSaving()) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
        <span>Saving...</span>
        } @else {
        <ng-container>
          <mat-icon>save</mat-icon>
          <span>Save Carrier</span>
        </ng-container>
        }
      </button>
      }
    </div>
  </div>

  <form [formGroup]="carrierForm" class="detail-form">
    <mat-card class="detail-card">
      <mat-card-header
        ><mat-card-title>Basic Information</mat-card-title></mat-card-header
      >
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Carrier Name</mat-label>
          <input matInput formControlName="name" required />
          <mat-error>Name is required</mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>SCAC Code</mat-label>
          <input matInput formControlName="scacCode" required />
          <mat-error>SCAC Code is required</mat-error>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card class="detail-card" formGroupName="address">
      <mat-card-header
        ><mat-card-title>Address</mat-card-title></mat-card-header
      >
      <mat-card-content class="form-grid">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Street Address</mat-label>
          <input matInput formControlName="street" required />
        </mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>City</mat-label
          ><input matInput formControlName="city" required
        /></mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>State / Province</mat-label
          ><input matInput formControlName="state" required
        /></mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>Postal Code</mat-label
          ><input matInput formControlName="postalCode" required
        /></mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>Country</mat-label
          ><input matInput formControlName="country" required
        /></mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card class="detail-card">
      <mat-card-header
        ><mat-card-title>Contact & Insurance</mat-card-title></mat-card-header
      >
      <mat-card-content class="form-grid four-columns">
        <mat-form-field appearance="outline"
          ><mat-label>Contact Name</mat-label
          ><input matInput formControlName="contactName"
        /></mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>Contact Phone</mat-label
          ><input matInput formControlName="contactPhone"
        /></mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>Contact Email</mat-label
          ><input matInput type="email" formControlName="contactEmail"
        /></mat-form-field>
        <mat-form-field appearance="outline"
          ><mat-label>Insurance Policy #</mat-label
          ><input matInput formControlName="insurancePolicyNumber"
        /></mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Insurance Expiry</mat-label>
          <input
            matInput
            [matDatepicker]="picker"
            formControlName="insuranceExpiryDate"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <div class="toggle-group full-width">
          <mat-checkbox formControlName="certificationColdChain" color="primary"
            >Cold Chain Certified</mat-checkbox
          >
          <mat-slide-toggle formControlName="isActive" color="accent"
            >Is Active</mat-slide-toggle
          >
        </div>
      </mat-card-content>
    </mat-card>
  </form>

  @if(carrierId()) {
  <mat-card class="detail-card">
    <mat-card-header>
      <mat-card-title>Truck Fleet</mat-card-title>
      <button
        mat-stroked-button
        color="primary"
        (click)="openTruckDialog()"
        [disabled]="!isEditMode()"
      >
        <mat-icon>add</mat-icon>
        <span>Add Truck</span>
      </button>
    </mat-card-header>
    <mat-card-content class="location-table-content">
      <div class="table-container">
        <div class="spinner-overlay" *ngIf="isLoadingTrucks()">
          <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        </div>

        <table mat-table [dataSource]="truckDataSource" matSort>
          <ng-container matColumnDef="licensePlate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              License Plate
            </th>
            <td mat-cell *matCellDef="let truck" class="barcode-cell">
              {{ truck.licensePlate }}
            </td>
          </ng-container>
          <ng-container matColumnDef="model">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Model</th>
            <td mat-cell *matCellDef="let truck">{{ truck.model }}</td>
          </ng-container>
          <ng-container matColumnDef="capacityWeight">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Capacity (kg)
            </th>
            <td mat-cell *matCellDef="let truck">
              {{ truck.capacityWeight | number }} kg
            </td>
          </ng-container>
          <ng-container matColumnDef="isActive">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Active</th>
            <td mat-cell *matCellDef="let truck">
              <mat-icon [color]="truck.isActive ? 'primary' : 'disabled'">{{
                truck.isActive ? "toggle_on" : "toggle_off"
              }}</mat-icon>
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let truck">
              <button
                mat-icon-button
                color="primary"
                matTooltip="Edit Truck"
                (click)="openTruckDialog(truck)"
                [disabled]="!isEditMode()"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                matTooltip="Delete Truck"
                (click)="deleteTruck(truck)"
                [disabled]="!isEditMode()"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedTruckColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedTruckColumns"></tr>
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedTruckColumns.length">
              No trucks found for this carrier.
            </td>
          </tr>
        </table>
        <mat-paginator
          [pageSizeOptions]="[5, 10, 20]"
          showFirstLastButtons
        ></mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
  }
</div>
}
