@if(isLoading()) {
<div class="spinner-container">
  <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  <span>Loading Room Details...</span>
</div>
} @else {
<div class="detail-container">
  <div class="detail-header">
    <div class="header-main">
      <a mat-icon-button (click)="back()" matTooltip="Back to Room List">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <div class="title-group">
        <h2>{{ isNewRoom() ? "Create New Room" : roomForm.get("name")?.value }}</h2>
        <p class="subtitle">{{ isNewRoom() ? 'Define a new storage room or zone.' : 'Edit details and manage locations for this room.' }}</p>
      </div>
    </div>
    <div class="header-actions">
      @if(!isNewRoom() && !isEditMode()) {
        <button mat-stroked-button color="primary" (click)="isEditMode.set(true)">
          <mat-icon>edit</mat-icon>
          <span>Edit Room</span>
        </button>
      }
      @if(isEditMode()) {
        <button mat-stroked-button (click)="back()">
          <mat-icon>cancel</mat-icon>
          <span>Cancel</span>
        </button>
        <button mat-flat-button color="primary" (click)="saveRoom()" [disabled]="isSaving()">
          @if(isSaving()) {
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            <span>Saving...</span>
          } @else {
            <ng-container>
              <mat-icon>save</mat-icon>
              <span>{{ isNewRoom() ? 'Create Room' : 'Save Changes' }}</span>
            </ng-container>
            }
        </button>
      }
    </div>
  </div>

  <form [formGroup]="roomForm" class="detail-form">
    <mat-card class="detail-card">
      <mat-card-header>
        <mat-card-title>Room Details</mat-card-title>
      </mat-card-header>
      <mat-card-content class="form-grid four-columns">
        <mat-form-field appearance="outline" *ngIf="isNewRoom()">
          <mat-label>Parent Warehouse</mat-label>
          <mat-select formControlName="warehouseId" required>
            @for(wh of warehouses(); track wh.id) {
            <mat-option [value]="wh.id">{{ wh.name }}</mat-option>
            }
          </mat-select>
           <mat-error *ngIf="roomForm.get('warehouseId')?.hasError('required')">Warehouse is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Room Name</mat-label>
          <input matInput formControlName="name" required>
           <mat-error *ngIf="roomForm.get('name')?.hasError('required')">Name is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Service Type</mat-label>
          <mat-select formControlName="serviceType" required>
             @for(st of serviceTypes; track st) {
              <mat-option [value]="st">{{ st }}</mat-option>
             }
          </mat-select>
           <mat-error *ngIf="roomForm.get('serviceType')?.hasError('required')">Service Type is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Min Temp (°C)</mat-label>
          <input matInput type="number" formControlName="minTemp" required>
           <mat-error *ngIf="roomForm.get('minTemp')?.hasError('required')">Required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Max Temp (°C)</mat-label>
          <input matInput type="number" formControlName="maxTemp" required>
           <mat-error *ngIf="roomForm.get('maxTemp')?.hasError('required')">Required</mat-error>
        </mat-form-field>
      </mat-card-content>
    </mat-card>
  </form>

  @if(!isNewRoom()) {
    <mat-accordion class="location-generators-accordion" multi>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title><mat-icon>grid_on</mat-icon> Generate Rack Locations</mat-panel-title>
          <mat-panel-description>Bulk-create locations for a new bay</mat-panel-description>
        </mat-expansion-panel-header>
        <form [formGroup]="generateRackForm" (ngSubmit)="onGenerateRacks()" class="generator-form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Bay Name</mat-label>
            <input matInput formControlName="bay" placeholder="e.g., A01, B02" required>
          </mat-form-field>
           <mat-form-field appearance="outline">
            <mat-label>Zone Type</mat-label>
            <input matInput formControlName="zoneType" readonly>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Start Row</mat-label>
            <input matInput type="number" formControlName="startRow" min="1">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>End Row</mat-label>
            <input matInput type="number" formControlName="endRow" min="1">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Start Column</mat-label>
            <input matInput type="number" formControlName="startCol" min="1">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>End Column</mat-label>
            <input matInput type="number" formControlName="endCol" min="1">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Start Level</mat-label>
            <input matInput type="number" formControlName="startLevel" min="1">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>End Level</mat-label>
            <input matInput type="number" formControlName="endLevel" min="1">
          </mat-form-field>
          <button mat-flat-button color="primary" type="submit" [disabled]="generateRackForm.invalid || isGeneratingLocations()">
            @if(isGeneratingLocations()){
               <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
               <span>Generating...</span>
            } @else {
               <ng-container>
                 <mat-icon>apps</mat-icon>
                 <span>Generate</span>
               </ng-container>
               }
          </button>
        </form>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title><mat-icon>label</mat-icon> Add Simple Location</mat-panel-title>
          <mat-panel-description>Create a single Staging or Picking location</mat-panel-description>
        </mat-expansion-panel-header>
        <form [formGroup]="simpleLocationForm" (ngSubmit)="onAddSimpleLocation()" class="generator-form-grid simple-form">
           <mat-form-field appearance="outline">
            <mat-label>Location Name (Barcode)</mat-label>
            <input matInput formControlName="name" placeholder="e.g., STAGING-01" required>
          </mat-form-field>
           <mat-form-field appearance="outline">
            <mat-label>Zone Type</mat-label>
            <mat-select formControlName="zoneType" required>
                @for(type of locationTypes; track type) {
                  <mat-option [value]="type">{{type}}</mat-option>
                }
            </mat-select>
          </mat-form-field>
          <button mat-flat-button color="primary" type="submit" [disabled]="simpleLocationForm.invalid || isAddingSimpleLocation()">
            @if(isAddingSimpleLocation()){
               <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
               <span>Adding...</span>
            } @else {
               <ng-container>
                 <mat-icon>add</mat-icon>
                 <span>Add Location</span>
               </ng-container>
               }
          </button>
        </form>
      </mat-expansion-panel>
    </mat-accordion>

    <mat-card class="detail-card">
      <mat-card-header>
        <mat-card-title>Existing Locations</mat-card-title>
      </mat-card-header>
      <mat-card-content class="location-table-content">
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="full-width">
            <mat-label>Search Locations by Barcode or Bay</mat-label>
            <input matInput [formControl]="locationSearchControl">
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <div class="table-container">
          <div class="spinner-overlay" *ngIf="isLoadingTable()">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          </div>

          <table mat-table [dataSource]="dataSource" matSort>
            <ng-container matColumnDef="barcode">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Barcode </th>
              <td mat-cell *matCellDef="let loc" class="barcode-cell"> {{loc.barcode}} </td>
            </ng-container>
            <ng-container matColumnDef="bay">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Bay </th>
              <td mat-cell *matCellDef="let loc"> {{loc.bay}} </td>
            </ng-container>
            <ng-container matColumnDef="row">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Row </th>
              <td mat-cell *matCellDef="let loc"> {{loc.row}} </td>
            </ng-container>
            <ng-container matColumnDef="column">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Col </th>
              <td mat-cell *matCellDef="let loc"> {{loc.column}} </td>
            </ng-container>
            <ng-container matColumnDef="level">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Lvl </th>
              <td mat-cell *matCellDef="let loc"> {{loc.level}} </td>
            </ng-container>
             <ng-container matColumnDef="zoneType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Zone </th>
              <td mat-cell *matCellDef="let loc"> <span class="detail-chip zone-chip">{{loc.zoneType}}</span> </td>
            </ng-container>
            <ng-container matColumnDef="capacityWeight">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Capacity </th>
              <td mat-cell *matCellDef="let loc"> {{loc.capacityWeight | number:'1.0-0'}} kg </td>
            </ng-container>
            <ng-container matColumnDef="isEmpty">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Empty </th>
              <td mat-cell *matCellDef="let loc">
                 <mat-icon [color]="loc.isEmpty ? 'primary' : 'warn'">{{ loc.isEmpty ? 'check_circle' : 'do_not_disturb_on' }}</mat-icon>
              </td>
            </ng-container>
             <ng-container matColumnDef="isActive">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Active </th>
              <td mat-cell *matCellDef="let loc">
                 <mat-icon [color]="loc.isActive ? 'primary' : 'disabled'">{{ loc.isActive ? 'toggle_on' : 'toggle_off' }}</mat-icon>
              </td>
            </ng-container>
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let loc">
                <button mat-icon-button color="primary" matTooltip="Edit Location" (click)="openEditLocationDialog(loc)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" matTooltip="Delete Location" (click)="deleteLocation(loc)" [disabled]="!loc.isEmpty">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                No locations found for this room.
              </td>
            </tr>
          </table>

          <mat-paginator [length]="resultsLength()" [pageSizeOptions]="[10, 25, 100]" showFirstLastButtons></mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
}
