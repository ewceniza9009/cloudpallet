<div class="report-container">
  <div class="header-section">
    <div>
      <h1 class="mat-headline-6">User Management</h1>
      <p class="mat-body-1">Manage user roles and permissions across the system.</p>
    </div>
  </div>

  <div class="content-wrapper">
    @if (isLoading()) {
    <div class="spinner-container-page">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>Loading Users...</p>
    </div>
    } @else {
    @if (users().length === 0) {
    <div class="empty-list-message">
      <mat-icon>group_off</mat-icon>
      <h2>No Users Found</h2>
      <p>There are no users to display in the system.</p>
    </div>
    } @else {
    <div class="table-container">
      <table mat-table [dataSource]="users()" aria-label="System users and their roles">
        <!-- Username Column -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef>Username</th>
          <td mat-cell *matCellDef="let user">
            <span class="username-text">{{ user.username }}</span>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Full Name</th>
          <td mat-cell *matCellDef="let user">
            {{ user.firstName }} {{ user.lastName }}
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let user">
            <a [href]="'mailto:' + user.email" class="email-link">
              {{ user.email }}
            </a>
          </td>
        </ng-container>

        <!-- Role Display Column -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Current Role</th>
          <td mat-cell *matCellDef="let user">
            <div class="role-badge" [ngClass]="'role-' + user.role.toLowerCase()">
              <mat-icon class="role-icon">{{ getRoleOption(user.role).icon }}</mat-icon>
              <span>{{ getRoleOption(user.role).label }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let user">
            <button mat-stroked-button color="primary" [matMenuTriggerFor]="roleMenu" [matMenuTriggerData]="{ user: user }">
              <mat-icon>edit</mat-icon>
              <span>Change Role</span>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
    }
    }
  </div>
</div>

<!-- Role Selection Menu -->
<mat-menu #roleMenu="matMenu" class="role-menu" xPosition="before">
  <ng-template matMenuContent let-user="user">
    @for (roleOption of roleOptions; track roleOption.value) {
    <button mat-menu-item class="role-menu-item" [class.selected]="user.role === roleOption.value" (click)="onRoleChange(user.id, roleOption.value)">
      <div class="menu-item-content">
        <mat-icon class="menu-icon">{{ roleOption.icon }}</mat-icon>
        <div class="menu-text">
          <span class="menu-title">{{ roleOption.label }}</span>
          <span class="menu-desc">{{ roleOption.description }}</span>
        </div>
        @if (user.role === roleOption.value) {
        <mat-icon class="check-icon">check</mat-icon>
        }
      </div>
    </button>
    }
  </ng-template>
</mat-menu>
