<div class="dialog-container">
  <!-- Header -->
  <div class="dialog-header">
    <h2>Cargo Manifest</h2>
    <button mat-icon-button (click)="close()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="dialog-content">
    @if (isLoading()) {
      <div class="spinner-container">
        <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
      </div>
    } @else if (existingManifest()) {
      <div class="manifest-details">
        <div class="manifest-info">
          <span class="label">Manifest ID:</span>
          <span class="value">{{ existingManifest()?.id }}</span>
        </div>
        
        <h3 class="section-title">Items</h3>
        <mat-list class="compact-list">
          @for (line of existingManifest()?.lines; track line.materialId) {
            <mat-list-item>
              <mat-icon matListItemIcon class="list-icon">inventory_2</mat-icon>
              <div matListItemTitle class="item-title">{{ line.materialName }}</div>
              <div matListItemLine class="item-subtitle">Quantity: {{ line.expectedQuantity }}</div>
            </mat-list-item>
          }
        </mat-list>
      </div>
    } @else {
      <form [formGroup]="form">
        <div formArrayName="lines" class="lines-container">
          @for (line of lines.controls; track line; let i = $index) {
            <div [formGroupName]="i" class="line-item">
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="material-field">
                <mat-label>Material</mat-label>
                <input type="text" matInput formControlName="material" [matAutocomplete]="auto"
                       #trigger="matAutocompleteTrigger" (click)="trigger.openPanel()">
                <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
                  @for (option of filteredMaterials[i] | async; track option.id) {
                    <mat-option [value]="option">{{ option.name }}</mat-option>
                  }
                </mat-autocomplete>
              </mat-form-field>

              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="qty-field">
                <mat-label>Qty</mat-label>
                <input matInput type="number" formControlName="quantity" min="1">
              </mat-form-field>

              <button mat-icon-button color="warn" (click)="removeLine(i)" [disabled]="lines.length === 1" class="delete-btn">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          }
        </div>
        
        <button mat-stroked-button color="primary" (click)="addLine()" class="add-line-btn">
          <mat-icon>add</mat-icon> Add Line
        </button>
      </form>
    }
  </mat-dialog-content>

  <div class="dialog-actions">
    <button mat-stroked-button (click)="close()">Close</button>
    @if (!existingManifest() && !isLoading()) {
      <button mat-flat-button color="primary" (click)="save()" [disabled]="form.invalid || isSaving()">
        @if (isSaving()) {
          <ng-container>
            <mat-icon>hourglass_empty</mat-icon>
            <span>Saving...</span>
          </ng-container>
        } @else {
          Save Manifest
        }
      </button>
    }
  </div>
</div>
