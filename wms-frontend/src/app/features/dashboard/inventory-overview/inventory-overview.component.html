<div class="overview-container">
  <div class="header-section">
    <h1 class="mat-headline-6">Inventory Overview</h1>
    <p class="mat-body-1">Live grid-based visualization of storage utilization.</p>
  </div>

  <div class="filters-container">
    <div class="filter-header">
      <mat-icon>filter_list</mat-icon>
      <span>Filters</span>
      @if (hasActiveFilters()) {
        <button mat-button color="warn" (click)="clearFilters()">Clear All</button>
      }
    </div>
    <div class="filters-grid">
      <!-- Room Filter -->
      <mat-form-field appearance="outline" class="filter-item">
        <mat-label>Room</mat-label>
        <input matInput [ngModel]="filters().room" (ngModelChange)="updateFilter('room', $event)" placeholder="Filter Room">
      </mat-form-field>

      <!-- Bay Filter -->
      <mat-form-field appearance="outline" class="filter-item">
        <mat-label>Bay</mat-label>
        <input matInput [ngModel]="filters().bay" (ngModelChange)="updateFilter('bay', $event)" placeholder="Filter Bay">
      </mat-form-field>

      <!-- Row Filter -->
      <mat-form-field appearance="outline" class="filter-item small-filter">
        <mat-label>Row</mat-label>
        <input matInput [ngModel]="filters().row" (ngModelChange)="updateFilter('row', $event)" placeholder="R">
      </mat-form-field>

      <!-- Column Filter -->
      <mat-form-field appearance="outline" class="filter-item small-filter">
        <mat-label>Col</mat-label>
        <input matInput [ngModel]="filters().column" (ngModelChange)="updateFilter('column', $event)" placeholder="C">
      </mat-form-field>

      <!-- Level Filter -->
      <mat-form-field appearance="outline" class="filter-item small-filter">
        <mat-label>Lvl</mat-label>
        <input matInput [ngModel]="filters().level" (ngModelChange)="updateFilter('level', $event)" placeholder="L">
      </mat-form-field>
    </div>
  </div>

  @if(isLoading()) {
    <div class="spinner-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>Loading Inventory Overview...</p>
    </div>
  } @else if(filteredData(); as data) {
    <mat-expansion-panel class="summary-panel" [expanded]="false">
      <mat-expansion-panel-header>
        <mat-panel-title>High-Level Summary</mat-panel-title>
      </mat-expansion-panel-header>
      
      <div class="summary-content">
        <table mat-table [dataSource]="summaryData()" class="summary-table">
          <!-- Room Column -->
          <ng-container matColumnDef="room">
            <th mat-header-cell *matHeaderCellDef> Room </th>
            <td mat-cell *matCellDef="let row" class="room-cell"> {{row.room}} </td>
          </ng-container>

          <!-- Total Bays Column -->
          <ng-container matColumnDef="totalBays">
            <th mat-header-cell *matHeaderCellDef class="num-col"> Total Bays </th>
            <td mat-cell *matCellDef="let row" class="num-col"> {{row.totalBays}} </td>
          </ng-container>

          <!-- Utilization Column -->
          <ng-container matColumnDef="avgUtilization">
            <th mat-header-cell *matHeaderCellDef class="util-col"> Avg. Utilization </th>
            <td mat-cell *matCellDef="let row" class="util-col">
              <div class="util-wrapper">
                <span class="util-val">{{row.avgUtilization | number:'1.0-1'}}%</span>
                <mat-progress-bar mode="determinate" [value]="row.avgUtilization" class="util-bar" 
                  [ngClass]="{'high-util': row.avgUtilization > 90, 'med-util': row.avgUtilization > 60 && row.avgUtilization <= 90}">
                </mat-progress-bar>
              </div>
            </td>
          </ng-container>

          <!-- Full Bays Column -->
          <ng-container matColumnDef="fullBays">
            <th mat-header-cell *matHeaderCellDef class="num-col"> Full Bays </th>
            <td mat-cell *matCellDef="let row" class="num-col" [class.text-warn]="row.fullBays > 0" [class.text-muted]="row.fullBays === 0"> 
              {{row.fullBays}} 
            </td>
          </ng-container>

          <!-- Over Capacity Column -->
          <ng-container matColumnDef="overCapacityBays">
            <th mat-header-cell *matHeaderCellDef class="num-col"> Over Capacity </th>
            <td mat-cell *matCellDef="let row" class="num-col" [class.text-error]="row.overCapacityBays > 0" [class.text-muted]="row.overCapacityBays === 0"> 
              {{row.overCapacityBays}} 
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="summaryDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: summaryDisplayedColumns;"></tr>
        </table>
      </div>
    </mat-expansion-panel>

    <mat-accordion multi class="room-accordion">
      @for(room of data.rooms; track room.roomName) {
        <mat-expansion-panel class="room-panel" [expanded]="hasActiveFilters()">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>view_module</mat-icon>
              {{ room.roomName }}
            </mat-panel-title>
            <mat-panel-description>
              {{ room.bays.length }} Bays | Overall Utilization: {{ room.utilization | number:'1.0-1' }}%
            </mat-panel-description>
          </mat-expansion-panel-header>

          <ng-template matExpansionPanelContent>
            <mat-accordion multi class="bay-accordion">
              @for(bay of room.bays; track bay.bayName) {
                <mat-expansion-panel class="bay-panel" [expanded]="hasActiveFilters()">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>view_week</mat-icon>
                      Bay {{ bay.bayName }}
                    </mat-panel-title>
                    <mat-panel-description>
                      {{ bay.locations.length }} Locations | Utilization: {{ bay.utilization | number:'1.0-1' }}%
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <ng-template matExpansionPanelContent>
                    <div class="locations-grid">
                      @for(loc of bay.locations; track (loc.row + '-' + loc.column + '-' + loc.level)) {
                        <mat-card class="location-card" [ngClass]="getLocationStatusClass(loc.status, loc.utilization)" [matTooltip]="'Current: ' + (loc.currentWeight | number:'1.1-1') + ' / ' + (loc.capacityWeight | number:'1.1-1') + ' kg'" (click)="openLocationDialog(loc)">
                          <mat-card-header>
                            <mat-card-title>{{ 'R' + loc.row + 'C' + loc.column + 'L' + loc.level }}</mat-card-title>
                          </mat-card-header>
                          <mat-card-content>
                          </mat-card-content>
                          <mat-card-footer>
                            <mat-progress-bar mode="determinate" [value]="loc.utilization"></mat-progress-bar>
                            <span class="util-text">{{ loc.utilization | number:'1.0-0' }}%</span>
                          </mat-card-footer>
                        </mat-card>
                      }
                    </div>
                  </ng-template>

                </mat-expansion-panel>
              }
            </mat-accordion>
          </ng-template>
        </mat-expansion-panel>
      }
    </mat-accordion>

  } @else {
    <mat-card class="error-card">
      <mat-icon>error_outline</mat-icon>
      <h2>No Data Available</h2>
      <p>Could not load inventory overview. Please ensure a warehouse is selected and data is available.</p>
    </mat-card>
  }
</div>
