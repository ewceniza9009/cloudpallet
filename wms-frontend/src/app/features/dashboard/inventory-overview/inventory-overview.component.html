<div class="overview-container">
  <div class="header-section">
    <h1 class="mat-headline-6">Inventory Overview</h1>
    <p class="mat-body-1">Live grid-based visualization of storage utilization.</p>
  </div>

  @if(isLoading()) {
    <div class="spinner-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>Loading Inventory Overview...</p>
    </div>
  } @else if(overviewData(); as data) {
    <mat-expansion-panel class="summary-panel" [expanded]="false">
      <mat-expansion-panel-header>
        <mat-panel-title>High-Level Summary</mat-panel-title>
      </mat-expansion-panel-header>
      
      <div class="table-container">
          <table mat-table [dataSource]="summaryData()">
            <ng-container matColumnDef="room">
              <th mat-header-cell *matHeaderCellDef> Room </th>
              <td mat-cell *matCellDef="let row"> {{row.room}} </td>
            </ng-container>
            <ng-container matColumnDef="totalBays">
              <th mat-header-cell *matHeaderCellDef> Total Bays </th>
              <td mat-cell *matCellDef="let row"> {{row.totalBays}} </td>
            </ng-container>
            <ng-container matColumnDef="avgUtilization">
              <th mat-header-cell *matHeaderCellDef> Avg. Utilization </th>
              <td mat-cell *matCellDef="let row"> {{row.avgUtilization | number:'1.0-1'}}% </td>
            </ng-container>
            <ng-container matColumnDef="fullBays">
              <th mat-header-cell *matHeaderCellDef> Full Bays </th>
              <td mat-cell *matCellDef="let row"> {{row.fullBays}} </td>
            </ng-container>
            <ng-container matColumnDef="overCapacityBays">
              <th mat-header-cell *matHeaderCellDef> Over Capacity </th>
              <td mat-cell *matCellDef="let row" [ngClass]="{'cell-warn': row.overCapacityBays > 0}"> {{row.overCapacityBays}} </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="summaryDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: summaryDisplayedColumns;"></tr>
          </table>
      </div>
    </mat-expansion-panel>

    <mat-accordion multi class="room-accordion">
      @for(room of data.rooms; track room.roomName) {
        <mat-expansion-panel class="room-panel" [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>view_module</mat-icon>
              {{ room.roomName }}
            </mat-panel-title>
            <mat-panel-description>
              {{ room.bays.length }} Bays | Overall Utilization: {{ room.utilization | number:'1.0-1' }}%
            </mat-panel-description>
          </mat-expansion-panel-header>

          <mat-accordion multi class="bay-accordion">
            @for(bay of room.bays; track bay.bayName) {
              <mat-expansion-panel class="bay-panel" [expanded]="true">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>view_week</mat-icon>
                    Bay {{ bay.bayName }}
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ bay.locations.length }} Locations | Utilization: {{ bay.utilization | number:'1.0-1' }}%
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <div class="locations-grid">
                  @for(loc of bay.locations; track (loc.row + '-' + loc.column + '-' + loc.level)) {
                    <mat-card class="location-card" [ngClass]="getLocationStatusClass(loc.status, loc.utilization)" [matTooltip]="'Current: ' + (loc.currentWeight | number:'1.1-1') + ' / ' + (loc.capacityWeight | number:'1.1-1') + ' kg'">
                      <mat-card-header>
                        <mat-card-title>{{ 'R' + loc.row + 'C' + loc.column + 'L' + loc.level }}</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                      </mat-card-content>
                      <mat-card-footer>
                        <mat-progress-bar mode="determinate" [value]="loc.utilization"></mat-progress-bar>
                        <span class="util-text">{{ loc.utilization | number:'1.0-0' }}%</span>
                      </mat-card-footer>
                    </mat-card>
                  }
                </div>

              </mat-expansion-panel>
            }
          </mat-accordion>
        </mat-expansion-panel>
      }
    </mat-accordion>

  } @else {
    <mat-card class="error-card">
      <mat-icon>error_outline</mat-icon>
      <h2>No Data Available</h2>
      <p>Could not load inventory overview. Please ensure a warehouse is selected and data is available.</p>
    </mat-card>
  }
</div>
