<h2 mat-dialog-title>Find Stored Pallet</h2>
<mat-dialog-content class="dialog-content">
  <p>Use the filters below to find a stored pallet by account, material, or barcode.</p>

  <div class="filter-grid">
    <mat-form-field appearance="outline">
      <mat-label>Search by Barcode (Pallet or LPN)</mat-label>
      <input matInput [formControl]="barcodeControl" (input)="onFilterChange()" placeholder="e.g., (00)0123...">
      <mat-icon matSuffix>qr_code_scanner</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Filter by Account</mat-label>
      <input type="text"
             matInput
             [formControl]="accountControl"
             [matAutocomplete]="autoAccount"
             (input)="onFilterChange()">
      <mat-autocomplete #autoAccount="matAutocomplete"
                        [displayWith]="displayAccountName"
                        (optionSelected)="onFilterChange()">
        @for(account of filteredAccounts$ | async; track account.id) {
          <mat-option [value]="account">{{ account.name }}</mat-option>
        }
      </mat-autocomplete>
       @if(isLoadingLookups()) { <mat-progress-spinner matSuffix mode="indeterminate" diameter="20"></mat-progress-spinner> }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Filter by Material</mat-label>
      <input type="text"
             matInput
             [formControl]="materialControl"
             [matAutocomplete]="autoMaterial"
             (input)="onFilterChange()">
      <mat-autocomplete #autoMaterial="matAutocomplete"
                        [displayWith]="displayMaterialName"
                        (optionSelected)="onFilterChange()">
        @for(material of filteredMaterials$ | async; track material.id) {
          <mat-option [value]="material">{{ material.name }} ({{material.sku}})</mat-option>
        }
      </mat-autocomplete>
       @if(isLoadingLookups()) { <mat-progress-spinner matSuffix mode="indeterminate" diameter="20"></mat-progress-spinner> }
    </mat-form-field>
  </div>

  <div class="results-container">
    @if(isSearching()) {
      <div class="spinner-container">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      </div>
    } @else {
      @if(searchResults().length > 0) {
        <mat-selection-list [multiple]="false" (selectionChange)="onSelectionChange($event)">
          @for(pallet of searchResults(); track pallet.palletId) {
            <mat-list-option [value]="pallet" class="result-item">
              <mat-icon matListItemIcon>pallet</mat-icon>
              <div matListItemTitle>{{ pallet.palletBarcode }}</div>
              <div matListItemLine>
                <span>{{ pallet.accountName }} | Loc: {{ pallet.locationName }}</span>
              </div>
              <div matListItemLine class="item-summary">{{ pallet.materialSummary }}</div>
            </mat-list-option>
          }
        </mat-selection-list>
      } @else {
        <div class="empty-state">
          <mat-icon>search_off</mat-icon>
          <p>No pallets found matching your criteria.</p>
        </div>
      }
    }
  </div>

</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancel</button>
  <button mat-flat-button color="primary" (click)="onConfirm()" [disabled]="!selectedPallet()">
    Select Pallet
  </button>
</mat-dialog-actions>
