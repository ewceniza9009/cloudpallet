<div class="inventory-manager-container">
  
  <!-- Header & Search -->
  <header class="page-header">
    <div class="header-title">
      <h1>Inventory Manager</h1>
      <p>Operations Command Center</p>
    </div>
    
    <div class="search-bar-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" 
             [formControl]="searchControl" 
             placeholder="Scan SSCC or Pallet ID..." 
             class="custom-search-input"
             cdkFocusInitial>
      @if (searchControl.value) {
        <button class="clear-btn" (click)="searchControl.setValue('')">
          <mat-icon>close</mat-icon>
        </button>
      }
      <div class="search-actions">
        <button mat-stroked-button (click)="openSearchDialog()">Advanced Find</button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Fetching inventory data...</span>
    </div>
  }

  <!-- Main Content -->
  @if (foundPallet(); as pallet) {
    <div class="dashboard-grid">
      
      <!-- Pallet Context Card -->
      <div class="pallet-context-card">
        <div class="context-header">
          <div class="id-group">
            <span class="label">Active Pallet</span>
            <div class="value">{{ pallet.palletBarcode }}</div>
          </div>
          <div class="location-badge">
            <mat-icon>location_on</mat-icon>
            {{ pallet.currentLocationBarcode }}
          </div>
        </div>
        
        <div class="context-actions">
          <button mat-flat-button color="primary" (click)="onMove(pallet)">
            <mat-icon>open_with</mat-icon> Move Pallet
          </button>
          <button mat-stroked-button (click)="onLabelPallet(pallet)">
            <mat-icon>print</mat-icon> Label
          </button>
          <button mat-icon-button [matMenuTriggerFor]="moreActions" class="more-btn">
            <mat-icon>more_horiz</mat-icon>
          </button>
          <mat-menu #moreActions="matMenu">
            <button mat-menu-item (click)="onBlastFreeze(pallet)">
              <mat-icon>ac_unit</mat-icon> Blast Freeze
            </button>
            <button mat-menu-item (click)="startTransfer(pallet)">
              <mat-icon>call_split</mat-icon> Split / Transfer
            </button>
          </mat-menu>
        </div>
      </div>

      <!-- Inventory List -->
      <div class="inventory-list-section">
        <div class="section-header">
          <h3>Contents</h3>
          <span class="badge">{{ pallet.lines.length }} Items</span>
        </div>

        @if (pallet.lines.length === 0) {
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <p>This pallet is currently empty.</p>
          </div>
        } @else {
          <div class="inventory-cards">
            @for (line of pallet.lines; track line.barcode) {
              <div class="inventory-item-card" [class.quarantined]="getItemStatus(line.inventoryId) === 'Quarantined'">
                <div class="card-main">
                  <div class="item-meta">
                    <span class="material-name">{{ line.materialName }}</span>
                    <span class="lpn">LPN: {{ line.barcode }}</span>
                  </div>
                  <div class="item-qty">
                    <span class="qty-val">{{ line.quantity | number }}</span>
                    <span class="qty-unit">Units</span>
                  </div>
                </div>
                
                <div class="card-footer">
                  <div class="status-indicator">
                    <span class="dot" [class.active]="getItemStatus(line.inventoryId) === 'Available'" 
                          [class.warn]="getItemStatus(line.inventoryId) === 'Quarantined'"></span>
                    {{ getItemStatus(line.inventoryId) }}
                  </div>
                  
                  <div class="item-actions">
                    <button mat-icon-button (click)="onLabelItem(line)" matTooltip="Print Label">
                      <mat-icon>print</mat-icon>
                    </button>
                    @if (getItemStatus(line.inventoryId) === 'Available') {
                      <button mat-icon-button color="warn" (click)="onStartQuarantine(line)" matTooltip="Quarantine">
                        <mat-icon>gpp_bad</mat-icon>
                      </button>
                    }
                    @if (getItemStatus(line.inventoryId) === 'Quarantined') {
                      <button mat-icon-button color="primary" (click)="onCompleteFumigation(line)" matTooltip="Release">
                        <mat-icon>verified</mat-icon>
                      </button>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  } @else if (searchControl.value && searchControl.value.length > 5 && !isLoading()) {
    <div class="not-found">
      <mat-icon>search_off</mat-icon>
      <h3>No Pallet Found</h3>
      <p>Could not locate pallet "<strong>{{ searchControl.value }}</strong>"</p>
    </div>
  } @else if (!isLoading()) {
    <div class="empty-state">
      <div class="illustration">
        <mat-icon>qr_code_scanner</mat-icon>
      </div>
      <h3>Ready to Scan</h3>
      <p>Enter a Pallet ID or SSCC to view details and manage inventory.</p>
    </div>
  }
</div>
