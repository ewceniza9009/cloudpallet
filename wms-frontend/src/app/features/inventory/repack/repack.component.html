<div class="repack-container">
  <div class="header-section">
    <h1>Record Repackaging Service</h1>
    <p>Perform inventory transformation from one material SKU to another.</p>
  </div>

  <mat-card class="repack-form-card">
    <mat-card-header>
      <mat-card-title>Repackaging Transformation Form</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="repackForm" (ngSubmit)="onSubmit()" class="repack-form">

        <div class="form-section">
          <h3>1. Select Customer Account</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Account</mat-label>
            <input type="text"
                   matInput
                   formControlName="account"
                   [matAutocomplete]="autoAccount"
                   placeholder="Search for account..."
                   cdkFocusInitial>
            <mat-autocomplete #autoAccount="matAutocomplete"
                              [displayWith]="displayAccount"
                              (optionSelected)="onAccountSelected($event.option.value)">
              @for(account of filteredAccounts$ | async; track account.id) {
                <mat-option [value]="account">{{ account.name }}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
        </div>

        <div class="form-section" [class.disabled-section]="!repackForm.get('account')?.value">
          <h3>2. Select Target Material</h3>
          <div class="material-selection-grid">
            <mat-form-field appearance="outline" class="target-material-field">
              <mat-label>Target Material (Output)</mat-label>
              <input type="text"
                     matInput
                     formControlName="targetMaterial"
                     [matAutocomplete]="autoTarget"
                     placeholder="Search for material to create...">
              <mat-autocomplete #autoTarget="matAutocomplete"
                                [displayWith]="displayMaterial"
                                (optionSelected)="onTargetMaterialSelected($event.option.value)">
                @for(mat of filteredTargetMaterials$ | async; track mat.id) {
                  <mat-option [value]="mat">{{ mat.name }} ({{mat.sku}})</mat-option>
                }
              </mat-autocomplete>
              <mat-hint>Select an account first to enable material selection</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="form-section" [class.disabled-section]="!repackForm.get('targetMaterial')?.value">
          <h3>3. Select Source Inventory</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Source Inventory</mat-label>
            <input type="text"
                   matInput
                   formControlName="sourceInventory"
                   [matAutocomplete]="autoSource"
                   placeholder="Search by material or pallet...">
            @if(isLoadingSources()) {
              <mat-progress-spinner matSuffix mode="indeterminate" diameter="20"></mat-progress-spinner>
            }
            <mat-autocomplete #autoSource="matAutocomplete" [displayWith]="displaySource">
              @for(inv of displayableSourceInventories(); track inv.inventoryId) {
                <mat-option [value]="inv">
                  <div class="inventory-option">
                    <div class="inventory-main">{{ inv.materialName }} ({{inv.sku}})</div>
                    <div class="inventory-details">
                      Pallet: {{inv.palletBarcode}} | Location: {{inv.location}} | Available: {{inv.quantity}}
                    </div>
                  </div>
                </mat-option>
              }
            </mat-autocomplete>
            @if(displayableSourceInventories().length === 0 && repackForm.get('targetMaterial')?.value) {
              <mat-error>No valid source inventory found for this transformation</mat-error>
            }
            <mat-hint>Select a target material to see available sources</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-section">
          <h3>4. Processing Details</h3>
          <div class="processing-grid">
            <mat-form-field appearance="outline">
              <mat-label>Quantity to Process</mat-label>
              <input matInput type="number" formControlName="quantityToProcess" min="1">
              <mat-error *ngIf="repackForm.get('quantityToProcess')?.hasError('required')">Required</mat-error>
              <mat-error *ngIf="repackForm.get('quantityToProcess')?.hasError('min')">Must be at least 1</mat-error>
            </mat-form-field>
          </div>
        </div>

        <mat-card-actions align="end">
          <button mat-flat-button color="primary" type="submit" [disabled]="repackForm.invalid || isSubmitting()">
            @if(isSubmitting()) {
              <mat-progress-spinner diameter="20" mode="indeterminate" style="margin-right: 8px;"></mat-progress-spinner>
              <span>Processing...</span>
            } @else {
              <ng-container>
                <mat-icon>transform</mat-icon>
                <span>Record Repack</span>
              </ng-container>
            }
          </button>
        </mat-card-actions>
      </form>
    </mat-card-content>
  </mat-card>
</div>
