<div class="dialog-header">
  <div class="header-content">
    <h2 mat-dialog-title>Amend Transaction</h2>
    <div class="transaction-id">#{{ transaction()?.id | slice:0:8 }}</div>
  </div>
  <button mat-icon-button (click)="close()" class="close-button">
    <mat-icon>close</mat-icon>
  </button>
</div>

<mat-dialog-content class="dialog-content-refined">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading transaction details...</p>
    </div>
  } @else if (transaction()) {
    <!-- Transaction Summary Card -->
    <div class="summary-section">
      <div class="summary-card">
        <div class="card-row">
          <div class="summary-item">
            <span class="label">Service Type</span>
            <span class="value service-type">{{ transaction()!.serviceType }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Date</span>
            <span class="value">{{ transaction()!.timestamp | date:'medium' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">User</span>
            <span class="value">{{ transaction()!.userName }}</span>
          </div>
        </div>
        <div class="card-row description-row">
          <div class="summary-item full-width">
            <span class="label">Description</span>
            <span class="value">{{ transaction()!.description }}</span>
          </div>
        </div>
        @if (transaction()!.isVoided) {
          <div class="void-banner">
            <mat-icon>warning</mat-icon>
            <span>This transaction has been VOIDED. Amendments are disabled.</span>
          </div>
        }
      </div>
    </div>

    <mat-tab-group animationDuration="0ms" class="refined-tabs" mat-stretch-tabs="false">
      <!-- Input Lines Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <div class="tab-label-content">
            <mat-icon class="tab-icon">input</mat-icon>
            <span>Input Lines</span>
            <span class="badge">{{ transaction()!.inputLines.length }}</span>
          </div>
        </ng-template>
        
        <div class="tab-content">
          @if (transaction()!.inputLines.length === 0) {
            <div class="empty-tab">
              <mat-icon>inbox</mat-icon>
              <p>No input lines found.</p>
            </div>
          } @else {
            <div class="expandable-list-container">
              <mat-accordion displayMode="flat" multi>
                @for (line of transaction()!.inputLines; track line.id) {
                  <mat-expansion-panel class="line-card" #panel>
                    <mat-expansion-panel-header [collapsedHeight]="'64px'" [expandedHeight]="'64px'">
                      <div class="panel-header-content">
                        <div class="material-info">
                          <div class="name-row">
                            <span class="material-name" [class.text-muted]="!line.materialId">
                              {{ line.materialId ? (line.materialName || 'Unknown Material') : 'Labor / Service' }}
                            </span>
                            @if (line.isAmended) {
                              <span class="amended-badge">AMENDED</span>
                            }
                          </div>
                          @if (line.materialId && !line.materialName) {
                            <span class="error-badge">Missing Material Data</span>
                          }
                        </div>

                        <div class="current-values">
                          <div class="value-item">
                            <span class="label">Qty</span>
                            <span class="value">{{ line.quantity | number }}</span>
                          </div>
                          @if (line.materialId) {
                            <div class="value-item">
                              <span class="label">Wgt</span>
                              <span class="value">{{ line.weight | number:'1.2-2' }} <small>kg</small></span>
                            </div>
                          }
                        </div>
                      </div>
                    </mat-expansion-panel-header>

                    <div class="panel-body">
                      <div class="amendment-form" [formGroup]="getFormGroup(line.id)">
                        <div class="inputs-grid">
                          <!-- Quantity Input -->
                          <mat-form-field appearance="outline" class="compact-field">
                            <mat-label>{{ line.materialId ? 'New Qty' : 'Duration (Hrs)' }}</mat-label>
                            <input matInput type="number" formControlName="newQuantity">
                          </mat-form-field>

                          <!-- Weight Input (Material Only) -->
                          @if (line.materialId) {
                            <mat-form-field appearance="outline" class="compact-field">
                              <mat-label>New Wgt (kg)</mat-label>
                              <input matInput type="number" formControlName="newWeight">
                            </mat-form-field>
                          }

                          <!-- Reason Input -->
                          <mat-form-field appearance="outline" class="reason-field">
                            <mat-label>Reason for Amendment</mat-label>
                            <input matInput formControlName="reason" placeholder="Required">
                          </mat-form-field>
                        </div>
                        
                        @if (line.isAmended) {
                          <div class="history-hint">
                            <mat-icon>history</mat-icon>
                            <span>Original: {{ line.originalQuantity }} | {{ line.originalWeight }} kg</span>
                          </div>
                        }

                        <div class="action-row" style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
                            <button mat-flat-button color="primary" 
                                    (click)="amendLine(line)"
                                    [disabled]="transaction()!.isVoided || getFormGroup(line.id).invalid || getFormGroup(line.id).pristine">
                                Save Changes
                            </button>
                        </div>
                      </div>
                    </div>
                  </mat-expansion-panel>
                }
              </mat-accordion>
            </div>
          }
        </div>
      </mat-tab>

      <!-- Output Lines Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <div class="tab-label-content">
            <mat-icon class="tab-icon">output</mat-icon>
            <span>Output Lines</span>
            <span class="badge">{{ transaction()!.outputLines.length }}</span>
          </div>
        </ng-template>

        <div class="tab-content">
          @if (transaction()!.outputLines.length === 0) {
            <div class="empty-tab">
              <mat-icon>outbox</mat-icon>
              <p>No output lines found.</p>
            </div>
          } @else {
            <div class="expandable-list-container">
              <mat-accordion displayMode="flat" multi>
                @for (line of transaction()!.outputLines; track line.id) {
                  <mat-expansion-panel class="line-card" #panel>
                    <mat-expansion-panel-header [collapsedHeight]="'64px'" [expandedHeight]="'64px'">
                      <div class="panel-header-content">
                        <div class="material-info">
                          <div class="name-row">
                            <span class="material-name" [class.text-muted]="!line.materialId">
                              {{ line.materialId ? (line.materialName || 'Unknown Material') : 'Labor / Service' }}
                            </span>
                            @if (line.isAmended) {
                              <span class="amended-badge">AMENDED</span>
                            }
                          </div>
                          @if (line.materialId && !line.materialName) {
                            <span class="error-badge">Missing Material Data</span>
                          }
                        </div>

                        <div class="current-values">
                          <div class="value-item">
                            <span class="label">Qty</span>
                            <span class="value">{{ line.quantity | number }}</span>
                          </div>
                          @if (line.materialId) {
                            <div class="value-item">
                              <span class="label">Wgt</span>
                              <span class="value">{{ line.weight | number:'1.2-2' }} <small>kg</small></span>
                            </div>
                          }
                        </div>
                      </div>
                    </mat-expansion-panel-header>

                    <div class="panel-body">
                      <div class="amendment-form" [formGroup]="getFormGroup(line.id)">
                        <div class="inputs-grid">
                          <!-- Quantity Input -->
                          <mat-form-field appearance="outline" class="compact-field">
                            <mat-label>{{ line.materialId ? 'New Qty' : 'Duration (Hrs)' }}</mat-label>
                            <input matInput type="number" formControlName="newQuantity">
                          </mat-form-field>

                          <!-- Weight Input (Material Only) -->
                          @if (line.materialId) {
                            <mat-form-field appearance="outline" class="compact-field">
                              <mat-label>New Wgt (kg)</mat-label>
                              <input matInput type="number" formControlName="newWeight">
                            </mat-form-field>
                          }

                          <!-- Reason Input -->
                          <mat-form-field appearance="outline" class="reason-field">
                            <mat-label>Reason for Amendment</mat-label>
                            <input matInput formControlName="reason" placeholder="Required">
                          </mat-form-field>
                        </div>
                        
                        @if (line.isAmended) {
                          <div class="history-hint">
                            <mat-icon>history</mat-icon>
                            <span>Original: {{ line.originalQuantity }} | {{ line.originalWeight }} kg</span>
                          </div>
                        }

                        <div class="action-row" style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
                            <button mat-flat-button color="primary" 
                                    (click)="amendLine(line)"
                                    [disabled]="transaction()!.isVoided || getFormGroup(line.id).invalid || getFormGroup(line.id).pristine">
                                Save Changes
                            </button>
                        </div>
                      </div>
                    </div>
                  </mat-expansion-panel>
                }
              </mat-accordion>
            </div>
          }
        </div>
      </mat-tab>

      <!-- History Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <div class="tab-label-content">
            <mat-icon class="tab-icon">history</mat-icon>
            <span>History</span>
            <span class="badge">{{ transaction()!.amendmentHistory.length }}</span>
          </div>
        </ng-template>

        <div class="tab-content history-container">
          @if (transaction()!.amendmentHistory.length === 0) {
            <div class="empty-tab">
              <mat-icon>history</mat-icon>
              <p>No amendment history available.</p>
            </div>
          } @else {
            <div class="timeline">
              @for (amendment of transaction()!.amendmentHistory; track amendment.id) {
                <div class="timeline-item">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <div class="timeline-header">
                      <span class="amendment-type">{{ amendment.amendmentType }}</span>
                      <span class="amendment-date">{{ amendment.timestamp | date:'medium' }}</span>
                    </div>
                    <div class="timeline-user">
                      <mat-icon>person</mat-icon> {{ amendment.userName }}
                    </div>
                    <div class="timeline-reason">
                      "{{ amendment.reason }}"
                    </div>
                    <div class="timeline-details">
                      <details>
                        <summary>View Technical Details</summary>
                        <pre>{{ parseJson(amendment.amendmentDetails) | json }}</pre>
                      </details>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </mat-tab>
    </mat-tab-group>
  }
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions-refined">
  @if (transaction() && !transaction()!.isVoided) {
    <button mat-button color="warn" (click)="voidTransaction()">Void Transaction</button>
  }
  <button mat-stroked-button (click)="close()">Close</button>
  <button mat-flat-button color="primary" (click)="close('success')">Done</button>
</mat-dialog-actions>
