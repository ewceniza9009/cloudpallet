<div class="billing-container">
  <div class="header-section">
    <div>
      <h1 class="mat-headline-6">Run Billing Cycle</h1>
      <p class="mat-body-1">Generate new invoices or view history for a customer account.</p>
    </div>
  </div>

  <form [formGroup]="billingForm" class="filter-grid">
    <mat-form-field appearance="outline" class="custom-field">
      <mat-label>Customer Account</mat-label>
      <input type="text"
             placeholder="Select Account"
             matInput
             formControlName="accountId"
             [matAutocomplete]="auto">
      <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
        <cdk-virtual-scroll-viewport itemSize="48" minBufferPx="200" maxBufferPx="400" class="autocomplete-viewport">
          <mat-option *cdkVirtualFor="let account of filteredAccounts | async" [value]="account">
            {{ account.name }}
          </mat-option>
        </cdk-virtual-scroll-viewport>
      </mat-autocomplete>
    </mat-form-field>

    <div formGroupName="period" class="filter-grid" style="gap: 1rem; margin: 0; padding: 0;">
      <mat-form-field appearance="outline" class="custom-field date-field">
        <mat-label>Billing Period</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate formControlName="start" placeholder="Start date">
          <input matEndDate formControlName="end" placeholder="End date">
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </div>

    <div class="filter-actions">
      <button mat-stroked-button color="primary" type="button" (click)="refreshInvoices()" [disabled]="!billingForm.get('accountId')?.value">
        <mat-icon>refresh</mat-icon>
        <span>Refresh</span>
      </button>
      <button mat-flat-button color="primary" type="button" [disabled]="billingForm.invalid || isGenerating()" (click)="generateInvoice()">
        @if(isGenerating()) {
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          <span>Generating...</span>
        } @else {
          <ng-container>
            <mat-icon>add_circle</mat-icon>
            <span>Generate Invoice</span>
          </ng-container>
        }
      </button>
    </div>
  </form>

  <mat-card class="invoice-list-card">
    <mat-card-header>
        <mat-card-title>Invoice History</mat-card-title>
    </mat-card-header>
    <mat-card-content style="padding: 0;">
      @if (isLoading()) {
        <div class="spinner-container">
          <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        </div>
      } @else {
        @if (invoices().length > 0) {
          <table mat-table [dataSource]="invoices()">
            <ng-container matColumnDef="invoiceNumber">
              <th mat-header-cell *matHeaderCellDef>Invoice #</th>
              <td mat-cell *matCellDef="let element"><strong>{{element.invoiceNumber}}</strong></td>
            </ng-container>
            <ng-container matColumnDef="period">
              <th mat-header-cell *matHeaderCellDef>Period</th>
              <td mat-cell *matCellDef="let element">
                {{element.periodStart | date:'MMM d, y'}} - {{element.periodEnd | date:'MMM d, y'}}
              </td>
            </ng-container>
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef>Due Date</th>
              <td mat-cell *matCellDef="let element">{{element.dueDate | date:'MMM d, y'}}</td>
            </ng-container>
            <ng-container matColumnDef="totalAmount">
              <th mat-header-cell *matHeaderCellDef class="align-right">Total</th>
              <td mat-cell *matCellDef="let element" class="align-right">{{element.totalAmount | currency: 'PHP' : 'symbol' : '1.2-2'}}</td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let element">
                <span class="status-badge" [ngClass]="element.status.toLowerCase()">{{element.status}}</span>
              </td>
            </ng-container>
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element" class="align-right">
                <a mat-icon-button color="primary" title="View Details" [routerLink]="['/billing', element.id]">
                  <mat-icon>visibility</mat-icon>
                </a>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        } @else {
           <div class="empty-message">
              <mat-icon>receipt_long</mat-icon>
              <h3>No Invoices Found</h3>
              <p>Select an account to view its invoice history or generate a new one.</p>
           </div>
        }
      }
    </mat-card-content>
  </mat-card>
</div>
