<div class="billing-container">
  <mat-card class="billing-form-card">
    <mat-card-header>
      <mat-card-title>Run Billing Cycle</mat-card-title>
      <mat-card-subtitle>Generate new invoices or view history for a customer account.</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="billingForm" class="billing-form">
        <div class="form-grid">
          <mat-form-field appearance="outline" class="account-selector">
            <mat-label>Customer Account</mat-label>
            <mat-select formControlName="accountId">
              @for (account of accounts(); track account.id) {
                <mat-option [value]="account.id">{{ account.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <div formGroupName="period" class="period-group">
            <mat-form-field appearance="outline">
              <mat-label>Billing Period Start</mat-label>
              <input matInput [matDatepicker]="startPicker" formControlName="start">
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Billing Period End</mat-label>
              <input matInput [matDatepicker]="endPicker" formControlName="end">
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>
        </div>
        <div class="actions">
          <button mat-stroked-button color="primary" type="button" (click)="refreshInvoices()" [disabled]="!billingForm.get('accountId')?.value">
            <mat-icon>refresh</mat-icon>
            <span>Refresh History</span>
          </button>
          <button mat-flat-button color="primary" type="button" [disabled]="billingForm.invalid || isGenerating()" (click)="generateInvoice()">
            @if(isGenerating()) {
              <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
              <span>Generating...</span>
            } @else {
              <ng-container>
                <mat-icon>add_circle</mat-icon>
                <span>Generate New Invoice</span>
              </ng-container>
            }
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card class="invoice-list-card">
    <mat-card-header>
        <mat-card-title>Invoice History</mat-card-title>
    </mat-card-header>
    <mat-card-content style="padding: 0;">
      @if (isLoading()) {
        <div class="spinner-container">
          <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        </div>
      } @else {
        @if (invoices().length > 0) {
          <table mat-table [dataSource]="invoices()">
            <ng-container matColumnDef="invoiceNumber">
              <th mat-header-cell *matHeaderCellDef>Invoice #</th>
              <td mat-cell *matCellDef="let element"><strong>{{element.invoiceNumber}}</strong></td>
            </ng-container>
            <ng-container matColumnDef="period">
              <th mat-header-cell *matHeaderCellDef>Period</th>
              <td mat-cell *matCellDef="let element">
                {{element.periodStart | date:'MMM d, y'}} - {{element.periodEnd | date:'MMM d, y'}}
              </td>
            </ng-container>
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef>Due Date</th>
              <td mat-cell *matCellDef="let element">{{element.dueDate | date:'MMM d, y'}}</td>
            </ng-container>
            <ng-container matColumnDef="totalAmount">
              <th mat-header-cell *matHeaderCellDef class="align-right">Total</th>
              <td mat-cell *matCellDef="let element" class="align-right">{{element.totalAmount | currency: 'PHP' : 'symbol' : '1.2-2'}}</td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let element">
                <span class="status-badge" [ngClass]="element.status.toLowerCase()">{{element.status}}</span>
              </td>
            </ng-container>
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element" class="align-right">
                <a mat-icon-button color="primary" title="View Details" [routerLink]="['/billing', element.id]">
                  <mat-icon>visibility</mat-icon>
                </a>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        } @else {
           <div class="empty-message">
              <mat-icon>receipt_long</mat-icon>
              <h3>No Invoices Found</h3>
              <p>Select an account to view its invoice history or generate a new one.</p>
           </div>
        }
      }
    </mat-card-content>
  </mat-card>
</div>
